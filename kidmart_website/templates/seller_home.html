<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller | KIDMART</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/seller_home-style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">
    <link rel="icon" href="{{ url_for('static', filename='css/images/LOGO_icon.ico') }}" type="image/x-icon">
</head>
<body>
    <header>
        <a href="#" class="Logo">
            <img src="{{ url_for('static', filename='css/images/LOGO.png') }}" alt="">
        </a>
        <div class="header-text">Welcome, Seller!</div>
        <div class="navicons">
            <a href="#" class="msg_icon" id="msg_icon" title="Messages">
                <img src="{{ url_for('static', filename='css/images/msg_icon.png') }}">
            </a>
            <div id="msgModal" class="msgModal" style="display:none;"> 
                <div class="msghead">
                    <p class="mzgz">Messages</p>
                    <!-- <a href="#" class="newchat" id="newchat">+ New Chat</a> -->
                    <select name="zeller" style="display:none;">
                        <option><!-- all buyer names --></option>
                    </select>
                </div>
                <p id="seller_id" style="display:none;">{{ seller_id }}</p>
                <div class="msgsss">
                    {% for msg in messages %}
                    <a href="#" class="message" data-buyer-id="{{ msg.buyer_id }}">
                        <div class="msgmsg">
                            <p class="mseller">{{ msg.buyer_name }}</p>
                            <p class="mdate">{{ msg.last_msg_time }}</p>
                        </div>
                        <p class="mtext">{{ msg.last_msg }}</p>
                    </a>
                    {% endfor %}
                </div>
            </div>

            <a href="#" class="notif_icon" id="notif_icon" title="Notifications">
                <img src="{{ url_for('static', filename='css/images/notif_icon.png') }}">
            </a>
            <div class="notifs_container" id="notifs_container" style="display: none;">
                <p class="nttl">Notifications</p>
                {% for notif in notifs %}
                <div class="notif_card">
                    <div class="titcon">
                        <p class="ntitle">{{ notif.snotif_title }}</p>
                        <p class="ndate">{{ notif.notif_datetime }}</p>
                    </div>
                    <p class="ntext">{{ notif.snotif_text }}</p>
                </div>
                {% endfor %}
            </div>

            <a href="{{ url_for('seller_orders', seller_id=seller_id) }}" class="orders_icon" title="Orders">
                <img src="{{ url_for('static', filename='css/images/orders_icon.png') }}">
            </a>
            <a href="#" class='person_icon' id="person_icon" title="Profile">
                <img src="{{ url_for('static', filename='css/images/person_icon.png') }}">
            </a>
            <div id="profileDetails" class="profileDetails" style="display: none;">
                <a href="{{ url_for('gotologin') }}" class="logout_btn" onclick="return confirmLogout()">Log Out</a>
            </div>
            
            <p name="seller_id" style="display: none;">{{ seller_id }}</p>
        </div>
    </header>

    <div class="messageModal" id="messageModal" style="display:none;"> 
        <div class="msgframe">
            <div class="messagehead">
                <p class="chatmate">Buyer Name</p>
                <button class="closemsg">&times;</button>
            </div>
            <input type="hidden" id="hidden_buyer_id" value="">
            <div class="chatbox"></div>
            <div class="chatsec">
                <input type="text" name="bchat" class="bchat" placeholder="Aa">
                <a href="#" class="send_chat">
                    <img src="{{ url_for('static', filename='css/images/send_btn.png') }}">
                </a>
            </div>
        </div>
    </div>

    <section class="salesrep">
        <div class="salesreport">
            <p class="srep">Sales Report</p>
            <div class="sales_radio">
                <p class="filterby">Filter by:</p>
                <div class="sales_radio-group">
                    <label class="orderslbl"><input type="radio" name="filterby" value="Orders" checked>&nbsp; Orders</label>
                    <label class="productslbl"><input type="radio" name="filterby" value="Products">&nbsp; Products</label>
                </div>
            </div>
            <div class="filterdate">
                <p class="datef">Date Range:</p>
                <div class="date_inputs">
                    <input type="date" class="date_from" required>
                    <p class="line">-</p>
                    <input type="date" class="date_to" required>
                </div>
                <button type="button" name="ok_btn" class="ok_btn">OK</button>
            </div>     
            <div class="sales_table">
                <table>
                    <thead>
                        <tr class="s">
                            <th>Transaction Date</th>
                            <th>Order ID</th>
                            <th>Products</th>
                            <th>Customer</th>
                            <th>Subtotal</th>
                            <th>Seller Profit</th>
                            <th class="admh">Admin Commission</th>
                        </tr>
                    </thead>
                    <tbody class="sales_body">
                        {% for order in order_summary %}
                            <tr>
                                <td>{{ order['order_delivered_datetime'] }}</td>
                                <td>{{ order['order_id'] }}</td>
                                <td>{{ order['product_titles'] }}</td>
                                <td>{{ order['buyer_id'] }}</td>
                                <td>₱{{ order['total'] }}</td>
                                <td>₱{{ order['net_total'] }}</td>
                                <td class="adm">₱{{ order['admin_com'] }}</td>
                            </tr>
                        {% endfor %}
                        <tr style="border-top: 2px solid #444;">
                            <td colspan="1" style="border: none; font-weight: bold; background-color:#f2f2f2; margin-top:7px;">Total:</td>
                            <td style="border: none; background-color:#f2f2f2; margin-top:7px;">{{ total_orders }}</td>
                            <td colspan="2" style="border: none; background-color:#f2f2f2; padding-top:10px;"></td>
                            <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱{{ total_price }}</td>
                            <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱{{ total_profit }}</td>
                            <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱{{ total_commission }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="printlol">
                <button class="printsales" onclick="printReport()">Print</button>
            </div>
        </div>
    </section>

    <section class="main">
        <p class="prod_head">My Products</p>
        <div class="maincontents">               
            <input type="search" id="search-input" placeholder="Search for product titles">
            <div class="frame1">
                <div class="categoriesandbutton">
                    <select name="categoriez" id="categoriez">
                        <option value="" selected>All Products</option>
                        <option value="Baby Clothes & Accessories">Baby Clothes & Accessories</option>
                        <option value="Educational Materials">Educational Materials</option>
                        <option value="Nursery Furniture">Nursery Furniture</option>
                        <option value="Safety & Health">Safety & Health</option>
                        <option value="Stroller & Gear">Stroller & Gear</option>
                        <option value="Toys & Games">Toys & Games</option>
                    </select>
                    <button id="newprods-btn" class="newprods-btn">List New Product</button>
                </div>
    
                <div class="product-container">
                    {% for product in products %}
                        <div class="product-card">
                            <div class="product-images">
                                {% if product.pimages %}
                                    <img src="data:image/jpeg;base64,{{ product.pimages[0] }}" alt="{{ product.ptitle }}">
                                {% else %}
                                    <p>No image available.</p>
                                {% endif %}
                            </div>
                            <input type="hidden" name="pid" value="{{ product.pid }}">
                            <p class="prod-ctgry">{{ product.pcategory }}</p>
                            <p class="prod-title">{{ product.ptitle }}</p>
                            <p class="solddd">{{ product.num_sold }} sold</p>
                            <p class="pdesc">{{ product.pdesc }}</p>
                            <ul>
                                {% for variation in product.variations %}
                                    <li>
                                        <span class="variation-name"><strong>{{ variation.name }}</strong></span>  
                                        <span class="variation-price">₱{{ variation.price }}</span>  
                                        <span class="variation-stocks">{{ variation.pstocks }}&nbsp;stocks left</span>
                                    </li>
                                {% endfor %}
                            </ul>
                            <div class="action-buttons">
                                <a href="#" class="edit_prod_btn">Edit</a>
                                <a href="#" class="delete_prod_btn">Remove</a>
                            </div>
                        </div>
                    {% else %}
                        <p>No products found.</p>
                    {% endfor %}
                </div>
            </div>
        </div>      
    </section>

    <div id="AddProdModal" class="AddProdModal"> 
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Product</h2>
            <form id="addProdForm" action="{{ url_for('add_product') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="seller_id" value="{{ seller_id }}">
    
                <label for="product_ctgrs">Product Category</label>
                <select name="product_ctgrs" required>
                    <option value="" selected disabled>Select Category</option>
                    <option value="Baby Clothes & Accessories">Baby Clothes & Accessories</option>
                    <option value="Educational Materials">Educational Materials</option>
                    <option value="Nursery Furniture">Nursery Furniture</option>
                    <option value="Safety & Health">Safety & Health</option>
                    <option value="Stroller & Gear">Stroller & Gear</option>
                    <option value="Toys & Games">Toys & Games</option>
                </select>
    
                <label for="product_image">Image(s)</label>
                <div id="image-inputs">
                    <input type="file" name="product_images" accept="image/*" multiple required>
                </div>
                <button class="add_img" type="button" onclick="addImageInput()">Add Another Image</button>

                <label for="product_title">Product Title</label>
                <input type="text" name="product_title" placeholder="Example: Baby Oil Non-Allergenic" required>
    
                <label for="product_desc">Description</label>
                <textarea name="product_desc" rows="3" placeholder="Example: Baby oil is a gentle, moisturizing oil formulated to protect and soften a baby’s delicate skin, often made from mineral oil and sometimes infused with soothing fragrances." required></textarea>                
    
                <label for="product_variation">Variations</label>
                <div id="variation-inputs">
                    <div class="variation-group">
                        <input type="text" name="product_variation[]" placeholder="Size, Color, etc." required>
                        <input type="number" name="variation_price[]" placeholder="Price" min="1" required>
                        <input type="number" name="variation_stocks[]" placeholder="Stocks" required>
                    </div>
                </div>
                <button class="add_var" type="button" onclick="addVariationInput()">Add Another Variation</button>
    
                <button class="list_prod" type="submit">List Product</button>
            </form>
        </div>
    </div>

    <div id="editModal" style="display:none;">
        <div class="editmodal-content">
            <span id="closeModal">&times;</span>
            <p class="editprodh">Edit Product</p>
    
            <form id="editProductForm" action="/edit_product" method="post" enctype="multipart/form-data">
                <input type="hidden" name="pid" id="edit-pid">
                <label for="edit-ptitle">Product Title</label>
                <input type="text" id="edit-ptitle" name="ptitle">
                <label for="edit-pdesc">Description</label>
                <textarea id="edit-pdesc" name="pdesc"></textarea>
    
                <label>Images</label>
                <div id="edit-images-container" class="image-gallery"></div>
                <label for="edit-images">Add Images</label>
                <input type="file" name="images" accept="image/*" multiple>
                <button class="addimgbtn" type="button" onclick="addImage()">Add Another Image</button>

                <label class="varzz">Variations</label>
                <div id="edit-variations"></div>
                <button type="button" class="addvarbtn" onclick="addVariation()">Add Variation</button>
    
                <button type="submit" class="save_btn">Save Changes</button>
            </form>
        </div>
    </div>
    
    <script>
        function addImage() {
            const imageInputs = document.getElementById('edit-images-container');
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.name = 'images';
            newInput.accept = 'image/*';
            newInput.multiple = true;
            imageInputs.appendChild(newInput);
        }

        function addVariation() {
            const variationsContainer = document.getElementById('edit-variations');
            const variationElem = document.createElement('div');
            variationElem.innerHTML = `
                <input type="hidden" name="variation_id" value="">
                <input type="text" name="variation_name" placeholder="Size, Color, etc." required>
                <input type="number" name="variation_price" placeholder="Price" min="1" required>
                <input type="number" name="variation_stocks" placeholder="Stocks" required>
            `;
            variationsContainer.appendChild(variationElem);
        }
    </script>    

    <section class="contacts">
        <div class="contact-info">
            <div class="first-info">
                <img src="{{ url_for('static', filename='css/images/LOGO.png') }}" alt="">
                <p>2023 by Kidmart. <br> A Kidmart Enterprise, Company </p>
            </div>
            <div class="second-info">
                <h4>"Everything Kids Want, Everything Parents Need."</h4>
                <p>At KidMart, we understand that raising kids is a 24/7 job, and we're here to support you every step of the way. From the first moments of infancy through the teenage years, we provide a  carefully selected range of products that cater to your child’s needs and your parenting goals.</p>
            </div>
            <div class="third-info">    
                <h2>Contact Us</h2>
                <p>Phone: 0900 000 0000</p>
                <p>Email: info@KidMart.com</p>
                <p>Kidmart <br> PO Box 1232 <br> Manila, PH. 1002</p>
            </div>
            <div class="fourth-info">
                <h2>Follow Us On</h2>
                <div class="social-icon">
                    <a href="www.facebook.com"><i class='bx bxl-facebook'></i></a>
                    <a href="www.instagram.com"><i class='bx bxl-instagram' ></i></a>
                    <a href="www.x.com"><i class='bx bxl-twitter' ></i></a>
                </div>
            </div>
        </div>
    </section>
    <div class="end-text">
        <p>© Copyright 2024. KidMart Enterprise Co. All Rights reserved.</p>
    </div>
    
    <script>
        function confirmLogout() {
            return confirm("Are you sure you want to log out?");
        }

        
        document.querySelector('.person_icon').addEventListener('click', function(event) {
            event.preventDefault();
            const profileDetails = document.getElementById('profileDetails');
            profileDetails.style.display = profileDetails.style.display === 'block' ? 'none' : 'block';
        });

        document.getElementById('msg_icon').addEventListener('click', function(e) {
            e.preventDefault();
            const msgModal = document.getElementById('msgModal');
            msgModal.style.display = msgModal.style.display === 'block' ? 'none' : 'block';
        });

        document.querySelectorAll('.message').forEach(message => {
            message.addEventListener('click', function (e) {
                e.preventDefault();

                const buyerId = this.dataset.buyerId;
                const sellerId = document.getElementById('seller_id').textContent.trim();
                const buyerName = this.querySelector('.mseller').textContent;

                document.querySelector('.chatmate').textContent = buyerName;
                document.getElementById('hidden_buyer_id').value = buyerId;

                fetch(`/sget_messages?seller_id=${sellerId}&buyer_id=${buyerId}`)
                    .then(response => response.json())
                    .then(data => {
                        const chatbox = document.querySelector('.chatbox');
                        chatbox.innerHTML = '';

                        data.messages.forEach(msg => {
                            const bubbleWrapper = document.createElement('div');

                            if (msg.smsg_text) {
                                bubbleWrapper.className = 'seller-bubble';
                                const msgElement = document.createElement('div');
                                msgElement.className = 'chat-bubble white-bubble';
                                msgElement.textContent = msg.smsg_text;
                                bubbleWrapper.appendChild(msgElement);
                            } else if (msg.bmsg_text) {
                                bubbleWrapper.className = 'buyer-bubble';
                                const msgElement = document.createElement('div');
                                msgElement.className = 'chat-bubble blue-bubble';
                                msgElement.textContent = msg.bmsg_text;
                                bubbleWrapper.appendChild(msgElement);
                            }

                            chatbox.appendChild(bubbleWrapper);
                        });

                        document.getElementById('msgModal').style.display = 'none';
                        document.getElementById('messageModal').style.display = 'block';
                    })
                    .catch(error => console.error('Error fetching messages:', error));
            });
        });

        document.querySelector('.closemsg').addEventListener('click', function() {
            document.getElementById('messageModal').style.display = 'none';
        });

        document.querySelector('.send_chat').addEventListener('click', function (e) {
            e.preventDefault();

            const bmsgText = document.querySelector('.bchat').value.trim();
            const sellerId = document.getElementById('seller_id').textContent.trim();
            const buyerId = document.getElementById('hidden_buyer_id').value;

            if (!bmsgText) {
                alert('Message cannot be empty');
                return;
            }

            const formData = new FormData();
            formData.append('buyer_id', buyerId);
            formData.append('seller_id', sellerId);
            formData.append('bmsg_text', bmsgText);

            fetch('/ssend_message', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const chatbox = document.querySelector('.chatbox');
                        const bubbleWrapper = document.createElement('div');
                        bubbleWrapper.className = 'seller-bubble';
                        const msgElement = document.createElement('div');
                        msgElement.className = 'chat-bubble white-bubble';
                        msgElement.textContent = bmsgText;
                        bubbleWrapper.appendChild(msgElement);
                        chatbox.appendChild(bubbleWrapper);

                        document.querySelector('.bchat').value = '';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to send the message. Please try again.');
                });
        });


        document.querySelector('.notif_icon').addEventListener('click', function(event) {
            event.preventDefault();
            const profileDetails = document.getElementById('notifs_container');
            profileDetails.style.display = profileDetails.style.display === 'block' ? 'none' : 'block';
        });


        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('editProductForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);

                fetch('/edit_product', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Product updated successfully!');
                        reloadProductCards();
                    } else {
                        alert('Error updating product.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the product.');
                });

                document.getElementById('editModal').style.display = 'none';
            });

            function reloadProductCards() {
                const sellerId = document.querySelector('p[name="seller_id"]').textContent;
                fetch(`/get_products/${sellerId}`)
                    .then(response => response.json())
                    .then(data => {
                        const products = data.products;
                        const productContainer = document.querySelector('.product-container');
                        productContainer.innerHTML = '';

                        products.forEach(product => {
                            const productCard = createProductCard(product);
                            productContainer.appendChild(productCard);
                        });

                        attachEditEventListeners();
                    })
                    .catch(error => console.error('Error loading products:', error));
            }

            function createProductCard(product) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'product-card';
                cardDiv.innerHTML = `
                    <div class="product-images">
                        ${product.pimages ? `<img src="data:image/jpeg;base64,${product.pimages[0]}" alt="${product.ptitle}">` : '<p>No image available.</p>'}
                    </div>
                    <input type="hidden" name="pid" value="${product.pid}">
                    <p class="prod-ctgry">${product.pcategory}</p>
                    <p class="prod-title">${product.ptitle}</p>
                    <p class="solddd">${product.num_sold} sold</p>
                    <ul>${product.variations.map(variation => `
                        <li>
                            <span class="variation-name"><strong>${variation.name}</strong></span>
                            <span class="variation-price">₱${variation.price}</span>
                            <span class="variation-stocks">${variation.pstocks} stocks left</span>
                        </li>
                    `).join('')}</ul>
                    <div class="action-buttons">
                        <a href="#" class="edit_prod_btn">Edit</a>
                        <a href="#" class="delete_prod_btn">Remove</a>
                    </div>
                `;
                return cardDiv;
            }

            function attachEditEventListeners() {
                document.querySelectorAll('.edit_prod_btn').forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        const productCard = this.closest('.product-card');
                        const pid = productCard.querySelector('input[name="pid"]').value;

                        fetch(`/get_product/${pid}`)
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('edit-pid').value = pid;
                                document.getElementById('edit-ptitle').value = data.ptitle;
                                document.getElementById('edit-pdesc').value = data.pdesc;

                                const variationsContainer = document.getElementById('edit-variations');
                                variationsContainer.innerHTML = '';
                                data.variations.forEach(variation => {
                                    const variationElem = document.createElement('div');
                                    variationElem.innerHTML = `
                                        <input type="hidden" name="variation_id" value="${variation.vid}">
                                        <input type="text" name="variation_name" value="${variation.name}">
                                        <input type="number" name="variation_price" value="${variation.price}">
                                        <input type="number" name="variation_stocks" value="${variation.pstocks}">
                                        <button type="button" class="removeVar">&times;</button>
                                    `;
                                    variationsContainer.appendChild(variationElem);
                                });

                                const imagesContainer = document.getElementById('edit-images-container');
                                imagesContainer.innerHTML = '';
                                data.images.forEach(image => {
                                    const imgDiv = document.createElement('div');
                                    imgDiv.className = 'image-container';
                                    imgDiv.innerHTML = `
                                        <img src="data:image/jpeg;base64,${image.base64}" class="thumbnail" alt="Product Image" />
                                        <button type="button" class="removeImg">&times;</button>
                                    `;
                                    imagesContainer.appendChild(imgDiv);
                                });

                                document.getElementById('edit-file-input').value = '';
                                document.getElementById('editModal').style.display = 'block';

                                variationsContainer.querySelectorAll('.removeVar').forEach(btn => btn.addEventListener('click', () => removeVariation(variation.vid)));
                                imagesContainer.querySelectorAll('.removeImg').forEach(btn => btn.addEventListener('click', () => removeImage(image.imgid)));
                            })
                            .catch(error => console.error('Error loading product data:', error));
                    });
                });
            }

            attachEditEventListeners();
        });



        document.querySelector('.ok_btn').addEventListener('click', () => {
            const dateFrom = document.querySelector('.date_from').value;
            const dateTo = document.querySelector('.date_to').value;

            if (dateFrom && dateTo) {
                fetch(`/filter_sales?date_from=${dateFrom}&date_to=${dateTo}`)
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.querySelector('.sales_body');
                        tbody.innerHTML = '';

                        if (data.order_summary.length === 0) {
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = `
                                <td class="empty_sales" colspan="8">No orders from date range selected.</td>
                            `;
                            tbody.appendChild(emptyRow);

                            tbody.insertAdjacentHTML('beforeend', `
                                <tr style="border-top: 2px solid #444;">
                                    <td colspan="1" style="border: none; font-weight: bold; background-color:#f2f2f2; margin-top:7px;">Total:</td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">0</td>
                                    <td colspan="2" style="border: none; background-color:#f2f2f2; padding-top:10px;"></td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱0.00</td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱0.00</td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱0.00</td>
                                </tr>
                            `);
                        } else {
                            data.order_summary.forEach(order => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${order[0]}</td>
                                    <td>${order[1]}</td>
                                    <td>${order[2]}</td>
                                    <td>${order[3]}</td>
                                    <td>₱${order[4]}</td>
                                    <td>₱${order[5]}</td>
                                    <td class="adm">₱${order[6]}</td>
                                `;
                                tbody.appendChild(row);
                            });

                            tbody.insertAdjacentHTML('beforeend', `
                                <tr style="border-top: 2px solid #444;">
                                    <td colspan="1" style="border: none; font-weight: bold; background-color:#f2f2f2; margin-top:7px;">Total:</td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">${data.total_orders}</td>
                                    <td colspan="2" style="border: none; background-color:#f2f2f2; padding-top:10px;"></td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱${data.total_price}</td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱${data.total_profit}</td>
                                    <td style="border: none; background-color:#f2f2f2; margin-top:7px;">₱${data.total_commission}</td>
                                </tr>
                            `);
                        }
                    });
            } else {
                alert("Please select both dates for the date range.");
            }
        });

        function printReport() {
            const selectedFilter = document.querySelector('input[name="filterby"]:checked').parentNode.textContent.trim();
            const dateFrom = document.querySelector('.date_from').value;
            const dateTo = document.querySelector('.date_to').value;
            const tableContent = document.querySelector('.sales_table').innerHTML;

            const printContents = `
                <div class="head">
                    <img src="{{ url_for('static', filename='css/images/LOGO.png') }}" alt="" class="printlogo">
                    <p class="headtitle">KidMart Enterprise Co.</p>
                </div>
                <div class="print-report">
                    <h2>Sales Report</h2>
                    <p>Filter by: ${selectedFilter}</p>
                    <p class="datez">Date Range: ${dateFrom} - ${dateTo}</p>
                    <div class="sales_table">
                        ${tableContent}
                    </div>
                </div>
                <div class="footer">
                    <div class="left">
                        <h5>Kidmart Enterpise Co.</h5>
                        <p>Searching for Kiddie Esssentials? There's nothing like Kidmart!</p>
                    </div>
                    <div class="right">
                        <p>Approved by:</p>
                        <div class="imgz">
                            <img src="{{ url_for('static', filename='css/images/sign.png') }}" alt="">
                        </div>
                    </div>
                </div>
            `;

            const originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;

            window.print();
            document.body.innerHTML = originalContents;
        }


        var modal = document.getElementById("AddProdModal");
        var btn = document.getElementById("newprods-btn");
        var span = document.getElementsByClassName("close")[0];
        var form = document.getElementById("addProdForm");

        btn.onclick = function() {
            modal.style.display = "block";
        }

        span.onclick = function() {
            modal.style.display = "none";
            resetForm();
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                resetForm();
            }
        }

        form.onsubmit = function() {
            modal.style.display = "none";
        }

        function resetForm() {
            const imageInputs = document.getElementById('image-inputs');
            const inputs = imageInputs.getElementsByTagName('input');
            while (inputs.length > 1) {
                imageInputs.removeChild(inputs[1]);
            }

            const variationInputs = document.getElementById('variation-inputs');
            const variationFields = variationInputs.getElementsByTagName('input');
            while (variationFields.length > 1) {
                variationInputs.removeChild(variationFields[1]);
            }

            inputs[0].value = '';
            variationFields[0].value = '';
        }

        function addImageInput() {
            const imageInputs = document.getElementById('image-inputs');
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.name = 'product_images';
            newInput.accept = 'image/*';
            imageInputs.appendChild(newInput);
        }

        function addVariationInput() {
            const variationInputs = document.getElementById('variation-inputs');
            
            const newVariationGroup = document.createElement('div');
            newVariationGroup.className = 'variation-group';
            
            const newVariationInput = document.createElement('input');
            newVariationInput.type = 'text';
            newVariationInput.name = 'product_variation[]';
            newVariationInput.placeholder = 'Example: Size M';
            newVariationGroup.appendChild(newVariationInput);
            
            const newPriceInput = document.createElement('input');
            newPriceInput.type = 'number';
            newPriceInput.name = 'variation_price[]';
            newPriceInput.placeholder = 'Price';
            newVariationGroup.appendChild(newPriceInput);

            const newStocksInput = document.createElement('input');
            newStocksInput.type = 'number';
            newStocksInput.name = 'variation_stocks[]';
            newStocksInput.placeholder = 'Stocks';
            newVariationGroup.appendChild(newStocksInput);
            
            variationInputs.appendChild(newVariationGroup);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.get('success') === '1') {
                alert("A new product has been listed!");
            }
        });


        document.querySelectorAll('.edit_prod_btn').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();

                const productCard = this.closest('.product-card');
                const pid = productCard.querySelector('input[name="pid"]').value;

                fetch(`/get_product/${pid}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('edit-pid').value = pid;

                        document.getElementById('edit-ptitle').value = data.ptitle;
                        document.getElementById('edit-pdesc').value = data.pdesc;

                        const variationsContainer = document.getElementById('edit-variations');
                        variationsContainer.innerHTML = '';
                        data.variations.forEach(variation => {
                            const variationElem = document.createElement('div');
                            variationElem.innerHTML = `
                                <input type="hidden" name="variation_id" value="${variation.vid}">
                                <input type="text" name="variation_name" value="${variation.name}">
                                <input type="number" name="variation_price" value="${variation.price}">
                                <input type="number" name="variation_stocks" value="${variation.pstocks}">
                                <button type="button" onclick="removeVariation(${variation.vid})" class="removeVar">&times;</button>
                            `;
                            variationsContainer.appendChild(variationElem);
                        });

                        const imagesContainer = document.getElementById('edit-images-container');
                        imagesContainer.innerHTML = '';
                        data.images.forEach(image => {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'image-container';
                            imgDiv.innerHTML = `
                                <img src="data:image/jpeg;base64,${image.base64}" class="thumbnail" alt="Product Image" />
                                <button type="button" onclick="removeImage(${image.imgid})" class="removeImg">&times;</button>
                            `;
                            imagesContainer.appendChild(imgDiv);
                        });

                        document.getElementById('editModal').style.display = 'block';
                    });
            });
        });


        document.getElementById('closeModal').onclick = function() {
            document.getElementById('editModal').style.display = 'none';
        };


        function removeImage(imgId) {
            if (confirm('Are you sure you want to remove this image?')) {
                fetch(`/remove_image/${imgId}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            document.getElementById(`img-${imgId}`).remove();
                            alert("Image removed successfully!");
                            displayImages(images);
                        } else {
                            console.error('Failed to remove image');
                            alert('Failed to remove image.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        function removeVariation(vid) {
            if (confirm('Are you sure you want to remove this variation?')) {
                fetch(`/remove_variation/${vid}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            document.getElementById(`variation-${vid}`).remove();
                            alert('Variation removed successfully!');

                            const pid = document.getElementById('edit-pid').value;
                            fetch(`/get_variations/${pid}`)
                                .then(res => res.json())
                                .then(updatedVariations => {
                                    displayVariations(updatedVariations);
                                });
                        } else {
                            console.error('Failed to remove variation');
                            alert('Failed to remove variation.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }


        function displayImages(images) {
            const imagesContainer = document.getElementById('edit-images-container');
            imagesContainer.innerHTML = '';

            images.forEach(image => {
                const imgDiv = document.createElement('div');
                imgDiv.id = `img-${image.imgid}`;

                imgDiv.innerHTML = `
                    <img src="data:image/jpeg;base64,${image.base64}" class="thumbnail" alt="Product Image" />
                    <button type="button" onclick="removeImage(${image.imgid})" class="removeImg">&times;</button>
                `;
                imagesContainer.appendChild(imgDiv);
            });
        }

        function displayVariations(variations) {
            const variationsContainer = document.getElementById('edit-variations');
            variationsContainer.innerHTML = '';

            variations.forEach(variation => {
                const variationDiv = document.createElement('div');
                variationDiv.id = `variation-${variation.vid}`;

                variationDiv.innerHTML = `
                    <input type="hidden" name="variation_id" value="${variation.vid}">
                    <input type="text" name="variation_name" value="${variation.variation}">
                    <input type="number" name="variation_price" value="${variation.price}">
                    <input type="number" name="variation_stocks" value="${variation.pstocks}">
                    <button type="button" onclick="removeVariation(${variation.vid})" class="removeVar">&times;</button>
                `;
                variationsContainer.appendChild(variationDiv);
            });
        }


        document.querySelectorAll('.delete_prod_btn').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();

                const productCard = this.closest('.product-card');
                const pid = productCard.querySelector('input[name="pid"]').value;

                const confirmDelete = confirm("Are you sure you want to delete this product?");
                if (confirmDelete) {
                    deleteProduct(pid);
                }
            });
        });

        function deleteProduct(pid) {
            fetch(`/delete_product/${pid}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        const productCard = document.querySelector(`input[value="${pid}"]`).closest('.product-card');
                        productCard.remove();
                        
                        alert("Product deleted successfully.");
                    } else {
                        console.error('Failed to delete product');
                        alert("Failed to delete product. Please try again.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("An error occurred while deleting the product.");
                });
        }

    </script>
</body>
</html>